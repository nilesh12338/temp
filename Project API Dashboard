<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>API Dashboard ‚Äì Dynamic Project API Downloader</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- JSZip + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { background-color: #f8f9fa; padding: 2rem; }
    .select2-container .select2-selection--multiple {
      min-height: 45px;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">üì¶ Project API Dashboard</h2>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <label for="projectSelect" class="form-label fw-semibold">Select Projects</label>
          <select id="projectSelect" class="form-select" multiple disabled>
            <option>Loading projects...</option>
          </select>
        </div>

        <div class="d-flex justify-content-end">
          <button id="downloadBtn" class="btn btn-primary" disabled>
            <i class="bi bi-download me-1"></i> Download Selected APIs
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastMsg" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      const $select = $('#projectSelect');
      const $button = $('#downloadBtn');
      const toastEl = document.getElementById('toastMsg');
      const toastBody = toastEl.querySelector('.toast-body');
      const toast = new bootstrap.Toast(toastEl);

      // Initialize empty Select2
      $select.select2({
        placeholder: "Select one or more projects",
        allowClear: true,
        width: '100%',
        theme: 'bootstrap-5'
      });

      // Simulate dynamic fetch from API endpoint
      // Replace with your actual endpoint, e.g., "/api/projects"
      $.ajax({
        url: '/api/projects',
        method: 'GET',
        dataType: 'json',
        success: function(projects) {
          $select.empty(); // clear loading
          projects.forEach(p => {
            $select.append(new Option(p.name, p.api_url, false, false)).attr('data-name', p.name);
          });
          $select.prop('disabled', false).trigger('change');
          $button.prop('disabled', false);
        },
        error: function() {
          $select.empty().append(new Option("‚ùå Failed to load projects", "", true, true));
          showToast("Error loading project list!", true);
        }
      });

      // Download selected APIs
      $button.on('click', async function() {
        const selected = $select.find(':selected');
        if (!selected.length) {
          showToast("Please select at least one project!", true);
          return;
        }

        $button.prop('disabled', true);

        const zip = new JSZip();
        for (let i = 0; i < selected.length; i++) {
          const opt = selected[i];
          const apiUrl = opt.value;
          const name = opt.text;
          try {
            const res = await fetch(apiUrl);
            const data = await res.text();
            zip.file(`${name}.json`, data);
          } catch (err) {
            zip.file(`${name}_error.txt`, `Failed to fetch ${apiUrl}\n${err}`);
          }
        }

        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, 'Selected_Project_APIs.zip');
        $button.prop('disabled', false);
        showToast("Selected APIs downloaded successfully!");
      });

      function showToast(message, isError = false) {
        toastBody.textContent = message;
        toastEl.classList.toggle('text-bg-danger', isError);
        toastEl.classList.toggle('text-bg-success', !isError);
        toast.show();
      }
    });
  </script>
</body>
</html>
